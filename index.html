<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LLMVis</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <h1>LLMVis</h1>
  <p>Visualize language models.</p>
  <label for="model-picker">Model:</label>
  <select id="model-picker">
    <option value="markov">Markov Chain</option>
    <option value="eliza">ELIZA</option>
  </select>
  <div id="markov-container" style="display: block;">
    <h2>Markov Chain Visualizer</h2>
    <form id="markov-form" autocomplete="off" onsubmit="return false;">
      <textarea id="inputText" rows="6" cols="60" placeholder="Paste your training text here..."></textarea>
      <div class="markov-row single">
        <div class="markov-label-input">
          <label for="order">Order:</label>
          <input type="number" id="order" min="1" max="5" value="2">
        </div>
      </div>
      <div class="markov-row single">
        <div class="markov-label-input">
          <label for="seed">Seed:</label>
          <input type="text" id="seed" placeholder="(optional)">
        </div>
      </div>
      <div class="markov-row single">
        <div class="markov-label-input">
          <label for="maxWords">Max Words:</label>
          <input type="number" id="maxWords" value="50">
        </div>
      </div>
      <div id="output" style="margin:1em 0; min-height:2em;"></div>
      <div class="markov-row" id="markov-btn-row">
        <button id="trainBtn" type="button">Train Model</button>
        <button id="generateBtn" type="button" disabled>Generate Text</button>
      </div>
    </form>
    <canvas id="graphCanvas" style="display:block; margin-top:2em; background:#fff; border:1px solid #eee;"></canvas>
  </div>
  <div id="eliza-container" style="display: none;">
    <h2>ELIZA</h2>
    <div id="eliza-chat-area">
      <div id="eliza-chat-log"></div>
      <form id="eliza-input-area" autocomplete="off" onsubmit="return false;">
        <input type="text" id="eliza-input" placeholder="Say something to ELIZA..." autocomplete="off">
        <button id="eliza-send" type="submit">Send</button>
      </form>
    </div>
    <div id="eliza-match-path"></div>
    <div id="eliza-tree" style="display:block;"></div>
  </div>
  <script src="markov.js"></script>
  <script src="elizabot.js"></script>
  <script src="eliza.js"></script>
  <script>
    // Model picker logic
    const modelPicker = document.getElementById('model-picker');
    const markovContainer = document.getElementById('markov-container');
    const elizaContainer = document.getElementById('eliza-container');
    const elizaTree = document.getElementById('eliza-tree');
    const elizaCollapseBtn = document.getElementById('eliza-collapse-tree');
    modelPicker.addEventListener('change', function() {
      if (this.value === 'eliza') {
        markovContainer.style.display = 'none';
        elizaContainer.style.display = 'block';
        if (typeof renderMarkovVisualizer === 'function') {
          renderMarkovVisualizer();
        }
      } else {
        markovContainer.style.display = 'block';
        elizaContainer.style.display = 'none';
      }
    });

    // Collapsible tree state
    let elizaTreeState = { expanded: { 'ELIZA': true } };

    // Helper: get path to match (keyword, decomp, reasmb)
    function getElizaMatchPath(match) {
      if (!match) return [];
      return ['ELIZA', match.keyword, match.decomp, match.reasmb];
    }

    // Render ELIZA rule tree as collapsible, auto-expanding to matchPath
    function renderElizaTree(matchedPath) {
      const tree = window.buildElizaRuleTree();
      const container = document.getElementById('eliza-tree');
      function renderNode(node, path = []) {
        const isRoot = path.length === 0;
        const expanded = elizaTreeState.expanded[node.name] || isRoot;
        const highlight = matchedPath && matchedPath.includes(node.name);
        const li = document.createElement('li');
        li.textContent = node.name;
        li.className = node.type + (highlight ? ' eliza-highlight' : '');
        if (isRoot) {
          li.style.cursor = 'pointer';
          li.onclick = () => {
            elizaTreeState.expanded[node.name] = !expanded;
            renderElizaTree(matchedPath);
          };
        }
        if (node.children && node.children.length && expanded) {
          const ul = document.createElement('ul');
          for (const child of node.children) {
            ul.appendChild(renderNode(child, path.concat(node.name)));
          }
          li.appendChild(ul);
        }
        return li;
      }
      container.innerHTML = '';
      const ul = document.createElement('ul');
      ul.appendChild(renderNode(tree));
      container.appendChild(ul);
    }

    // --- ELIZA Chat Bubble Logic ---
    const chatLog = document.getElementById('eliza-chat-log');
    const inputForm = document.getElementById('eliza-input-area');
    const inputBox = document.getElementById('eliza-input');
    function addChatBubble(text, sender) {
      const bubble = document.createElement('div');
      bubble.className = 'chat-bubble ' + (sender === 'eliza' ? 'eliza-bubble' : 'user-bubble');
      if (sender === 'eliza') {
        bubble.innerHTML = `<span class="eliza-avatar">üßë‚Äç‚öïÔ∏è</span><span class="bubble-text">${text}</span>`;
      } else {
        bubble.innerHTML = `<span class="bubble-text">${text}</span>`;
      }
      chatLog.appendChild(bubble);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    // Initial ELIZA greeting
    addChatBubble((new ElizaBot()).getInitial(), 'eliza');

    inputForm.onsubmit = function() {
      const input = inputBox.value.trim();
      if (!input) return false;
      addChatBubble(input, 'user');
      inputBox.value = '';
      const match = window.elizaMatchPath(input);
      let response = '';
      if (match) {
        elizaTreeState.expanded = { 'ELIZA': true };
        for (const name of match) {
          elizaTreeState.expanded[name] = true;
        }
        renderElizaTree(match);
        response = window.elizaSubstitute(match[2], match[3] || {}, match[4] || []);
        document.getElementById('eliza-match-path').innerHTML = `<b>Matched:</b> <br>Keyword: <code>${match[0]}</code><br>Decomp: <code>${match[1]}</code><br>Response: <code>${match[2]}</code>`;
      } else {
        response = '';
        document.getElementById('eliza-match-path').textContent = '';
      }
      setTimeout(() => addChatBubble(response, 'eliza'), 400);
      return false;
    };
    // Initial render
    renderElizaTree();
  </script>
</body>
</html> 